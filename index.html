<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baara Tehni - Online Multiplayer</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Poppins', sans-serif; }
        
        .board-cell {
            transition: all 0.2s ease;
        }
        
        .board-cell:hover:not(.has-piece):not(.disabled) {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .board-cell.selected {
            box-shadow: 0 0 0 4px #fbbf24, 0 0 20px rgba(251, 191, 36, 0.5);
            transform: scale(1.1);
        }
        
        .board-cell.valid-move {
            background: rgba(34, 197, 94, 0.3);
            animation: pulse 1s infinite;
        }
        
        .board-cell.capture-move {
            background: rgba(239, 68, 68, 0.3);
            animation: pulse 1s infinite;
        }
        
        .board-cell.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .piece {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        
        .piece:hover {
            transform: scale(1.15);
        }
        
        .piece.player1 {
            background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.5), inset 0 2px 4px rgba(255,255,255,0.3);
        }
        
        .piece.player2 {
            background: linear-gradient(135deg, #22c55e 0%, #15803d 100%);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.5), inset 0 2px 4px rgba(255,255,255,0.3);
        }
        
        .game-board {
            background: linear-gradient(145deg, #1e3a5f 0%, #0f172a 100%);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), inset 0 0 60px rgba(255,255,255,0.05);
        }
        
        .floating {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .toast {
            animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s forwards;
        }
        
        @keyframes toastIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes toastOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        
        .btn-glow:hover {
            box-shadow: 0 0 20px currentColor;
        }
        
        .coin {
            animation: coinFlip 1s ease-in-out;
        }
        
        @keyframes coinFlip {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(1800deg); }
        }
        
        .connecting-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .pulse-ring {
            animation: pulseRing 2s infinite;
        }
        
        @keyframes pulseRing {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .copy-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

    <!-- Main Menu Screen -->
    <div id="mainMenuScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white/10 backdrop-blur-xl rounded-3xl p-8 max-w-md w-full border border-white/20 slide-in">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-500 mb-2">
                    üéÆ Baara Tehni
                </h1>
                <p class="text-white/60">Online Multiplayer</p>
                <p class="text-white/40 text-sm mt-2">The Classic 12 Beads Strategy Game</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-white/80 font-medium mb-2">Your Name</label>
                    <input type="text" id="playerNameInput" placeholder="Enter your name..." 
                        class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:border-amber-400 focus:ring-2 focus:ring-amber-400/20 transition">
                </div>
                
                <button onclick="showCreateRoom()" 
                    class="w-full py-4 rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold text-lg hover:from-amber-600 hover:to-orange-600 transition transform hover:scale-[1.02] active:scale-[0.98] shadow-lg shadow-orange-500/30">
                    üè† Create Room
                </button>
                
                <button onclick="showJoinRoom()" 
                    class="w-full py-4 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-semibold text-lg hover:from-emerald-600 hover:to-teal-600 transition transform hover:scale-[1.02] active:scale-[0.98] shadow-lg shadow-emerald-500/30">
                    üîó Join Room
                </button>
                
                <button onclick="playOffline()" 
                    class="w-full py-3 rounded-xl bg-white/10 border border-white/20 text-white font-medium hover:bg-white/20 transition">
                    üéØ Play Offline
                </button>
            </div>
            
            <div class="mt-8 text-center text-white/40 text-sm">
                <p>Create a room and share the code with friends to play together!</p>
            </div>
        </div>
    </div>

    <!-- Create Room Screen -->
    <div id="createRoomScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white/10 backdrop-blur-xl rounded-3xl p-8 max-w-md w-full border border-white/20 slide-in">
            <button onclick="backToMenu()" class="text-white/60 hover:text-white mb-4 flex items-center gap-2">
                ‚Üê Back
            </button>
            
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-white mb-2">üè† Create Room</h2>
                <p class="text-white/60">Share this code with your friend</p>
            </div>
            
            <div class="bg-white/5 rounded-2xl p-6 mb-6">
                <p class="text-white/60 text-sm mb-2 text-center">Room Code</p>
                <div class="flex items-center justify-center gap-3">
                    <span id="roomCodeDisplay" class="text-4xl font-bold text-amber-400 tracking-widest"></span>
                    <button onclick="copyRoomCode()" class="copy-btn p-2 rounded-lg bg-white/10 hover:bg-white/20 transition">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mt-4 pt-4 border-t border-white/10">
                    <p class="text-white/60 text-sm mb-2 text-center">Or share this link</p>
                    <div class="flex items-center gap-2">
                        <input type="text" id="roomLinkDisplay" readonly
                            class="flex-1 px-3 py-2 rounded-lg bg-white/10 text-white/80 text-sm truncate">
                        <button onclick="copyRoomLink()" class="copy-btn px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition text-white text-sm">
                            Copy
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="text-center">
                <div class="inline-flex items-center gap-3 px-4 py-2 rounded-full bg-white/5">
                    <div class="relative">
                        <div class="w-3 h-3 bg-amber-400 rounded-full"></div>
                        <div class="absolute inset-0 w-3 h-3 bg-amber-400 rounded-full pulse-ring"></div>
                    </div>
                    <span class="text-white/60">Waiting for opponent<span class="connecting-dots"></span></span>
                </div>
            </div>
            
            <div id="connectionStatus" class="mt-4 text-center text-white/40 text-sm"></div>
        </div>
    </div>

    <!-- Join Room Screen -->
    <div id="joinRoomScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white/10 backdrop-blur-xl rounded-3xl p-8 max-w-md w-full border border-white/20 slide-in">
            <button onclick="backToMenu()" class="text-white/60 hover:text-white mb-4 flex items-center gap-2">
                ‚Üê Back
            </button>
            
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-white mb-2">üîó Join Room</h2>
                <p class="text-white/60">Enter the room code to join</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-white/80 font-medium mb-2">Room Code</label>
                    <input type="text" id="joinCodeInput" placeholder="Enter 6-digit code..." maxlength="6"
                        class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-400/20 transition text-center text-2xl tracking-widest uppercase">
                </div>
                
                <button onclick="joinRoom()" id="joinBtn"
                    class="w-full py-4 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-semibold text-lg hover:from-emerald-600 hover:to-teal-600 transition transform hover:scale-[1.02] active:scale-[0.98] shadow-lg shadow-emerald-500/30">
                    Join Game üéÆ
                </button>
            </div>
            
            <div id="joinStatus" class="mt-4 text-center text-white/40 text-sm"></div>
        </div>
    </div>

    <!-- Waiting Room Screen -->
    <div id="waitingRoomScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white/10 backdrop-blur-xl rounded-3xl p-8 max-w-md w-full border border-white/20 slide-in text-center">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-white mb-2">üéÆ Game Ready!</h2>
                <p class="text-white/60">Both players connected</p>
            </div>
            
            <div class="flex items-center justify-center gap-6 mb-8">
                <div class="text-center">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center text-white font-bold text-2xl mb-2">X</div>
                    <p id="waitingPlayer1" class="text-white font-medium"></p>
                    <p class="text-red-400 text-sm">Player 1</p>
                </div>
                <div class="text-white/40 text-2xl">VS</div>
                <div class="text-center">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white font-bold text-2xl mb-2">O</div>
                    <p id="waitingPlayer2" class="text-white font-medium"></p>
                    <p class="text-green-400 text-sm">Player 2</p>
                </div>
            </div>
            
            <div id="hostControls" class="hidden">
                <button onclick="hostStartGame()" 
                    class="w-full py-4 rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold text-lg hover:from-amber-600 hover:to-orange-600 transition transform hover:scale-[1.02] active:scale-[0.98] shadow-lg shadow-orange-500/30">
                    Start Game ‚ú®
                </button>
            </div>
            
            <div id="guestWaiting" class="hidden">
                <div class="inline-flex items-center gap-3 px-4 py-2 rounded-full bg-white/5">
                    <div class="relative">
                        <div class="w-3 h-3 bg-emerald-400 rounded-full"></div>
                        <div class="absolute inset-0 w-3 h-3 bg-emerald-400 rounded-full pulse-ring"></div>
                    </div>
                    <span class="text-white/60">Waiting for host to start<span class="connecting-dots"></span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="hidden min-h-screen p-4 md:p-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-500">
                    Baara Tehni
                </h1>
                <div id="onlineIndicator" class="hidden inline-flex items-center gap-2 mt-2 px-3 py-1 rounded-full bg-emerald-500/20 border border-emerald-500/30">
                    <div class="w-2 h-2 bg-emerald-400 rounded-full"></div>
                    <span class="text-emerald-400 text-sm">Online</span>
                </div>
            </div>
            
            <!-- Player Info -->
            <div class="flex justify-between items-center mb-6 gap-4">
                <div id="player1Card" class="flex-1 p-4 rounded-2xl bg-gradient-to-r from-red-500/20 to-red-600/10 border border-red-500/30 transition-all">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center text-white font-bold shadow-lg">X</div>
                        <div>
                            <p id="player1Name" class="text-white font-semibold"></p>
                            <p class="text-white/60 text-sm"><span id="player1Beads">12</span> beads</p>
                        </div>
                        <span id="player1You" class="hidden ml-2 px-2 py-0.5 rounded text-xs bg-red-500/30 text-red-300">YOU</span>
                    </div>
                </div>
                
                <div id="turnIndicator" class="px-4 py-2 rounded-full bg-amber-500/20 border border-amber-500/30">
                    <span id="turnText" class="text-amber-400 font-medium text-sm"></span>
                </div>
                
                <div id="player2Card" class="flex-1 p-4 rounded-2xl bg-gradient-to-r from-green-600/10 to-green-500/20 border border-green-500/30 transition-all">
                    <div class="flex items-center gap-3 justify-end">
                        <span id="player2You" class="hidden mr-2 px-2 py-0.5 rounded text-xs bg-green-500/30 text-green-300">YOU</span>
                        <div class="text-right">
                            <p id="player2Name" class="text-white font-semibold"></p>
                            <p class="text-white/60 text-sm"><span id="player2Beads">12</span> beads</p>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white font-bold shadow-lg">O</div>
                    </div>
                </div>
            </div>
            
            <!-- Game Board -->
            <div class="flex justify-center mb-6">
                <div class="game-board rounded-2xl p-4 md:p-6">
                    <!-- Column Numbers -->
                    <div class="flex mb-2 pl-8">
                        <div class="w-12 md:w-16 text-center text-cyan-400 font-medium">0</div>
                        <div class="w-12 md:w-16 text-center text-cyan-400 font-medium">1</div>
                        <div class="w-12 md:w-16 text-center text-cyan-400 font-medium">2</div>
                        <div class="w-12 md:w-16 text-center text-cyan-400 font-medium">3</div>
                        <div class="w-12 md:w-16 text-center text-cyan-400 font-medium">4</div>
                    </div>
                    
                    <div id="board" class="grid gap-1"></div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex flex-wrap justify-center gap-3 mb-6">
                <button onclick="requestRematch()" id="rematchBtn" class="hidden px-5 py-2.5 rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-medium hover:from-amber-600 hover:to-orange-600 transition flex items-center gap-2">
                    üîÑ Rematch
                </button>
                <button onclick="leaveGame()" class="px-5 py-2.5 rounded-xl bg-white/10 border border-white/20 text-white font-medium hover:bg-white/20 transition flex items-center gap-2">
                    üö™ Leave Game
                </button>
            </div>
            
            <!-- Instructions -->
            <div id="gameInstructions" class="text-center text-white/40 text-sm">
                <p>Click a piece to select, then click an empty cell to move. Jump over enemies to capture!</p>
            </div>
            
            <div id="waitingTurn" class="hidden text-center">
                <div class="inline-flex items-center gap-3 px-4 py-2 rounded-full bg-white/5">
                    <div class="relative">
                        <div class="w-3 h-3 bg-blue-400 rounded-full"></div>
                        <div class="absolute inset-0 w-3 h-3 bg-blue-400 rounded-full pulse-ring"></div>
                    </div>
                    <span class="text-white/60">Waiting for opponent's move<span class="connecting-dots"></span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Victory Modal -->
    <div id="victoryModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-8 max-w-md w-full border border-white/20 text-center slide-in">
            <div class="text-6xl mb-4">üèÜ</div>
            <h2 id="winnerText" class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-500 mb-4"></h2>
            <p id="winReason" class="text-white/60 mb-8"></p>
            <div class="flex gap-3 justify-center">
                <button onclick="requestRematch()" id="modalRematchBtn"
                    class="px-8 py-3 rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold hover:from-amber-600 hover:to-orange-600 transition">
                    Rematch üîÑ
                </button>
                <button onclick="leaveGame()" 
                    class="px-8 py-3 rounded-xl bg-white/10 border border-white/20 text-white font-semibold hover:bg-white/20 transition">
                    Leave üö™
                </button>
            </div>
        </div>
    </div>

    <!-- Disconnection Modal -->
    <div id="disconnectModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-8 max-w-md w-full border border-white/20 text-center slide-in">
            <div class="text-6xl mb-4">üò¢</div>
            <h2 class="text-2xl font-bold text-white mb-4">Opponent Disconnected</h2>
            <p class="text-white/60 mb-8">Your opponent has left the game.</p>
            <button onclick="backToMenu()" 
                class="px-8 py-3 rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold hover:from-amber-600 hover:to-orange-600 transition">
                Back to Menu
            </button>
        </div>
    </div>

    <!-- Rematch Request Modal -->
    <div id="rematchModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-8 max-w-md w-full border border-white/20 text-center slide-in">
            <div class="text-6xl mb-4">üîÑ</div>
            <h2 class="text-2xl font-bold text-white mb-4">Rematch Request</h2>
            <p id="rematchText" class="text-white/60 mb-8"></p>
            <div class="flex gap-3 justify-center">
                <button onclick="acceptRematch()" 
                    class="px-8 py-3 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-semibold hover:from-emerald-600 hover:to-teal-600 transition">
                    Accept ‚úì
                </button>
                <button onclick="declineRematch()" 
                    class="px-8 py-3 rounded-xl bg-white/10 border border-white/20 text-white font-semibold hover:bg-white/20 transition">
                    Decline ‚úó
                </button>
            </div>
        </div>
    </div>

<script>
    // Game Constants
    const BOARD_SIZE = 5;
    const ROOM_CODE_LENGTH = 6;

    // Game State
    let board = [];
    let player1Name = '';
    let player2Name = '';
    let currentPlayer = 1;
    let player1Beads = 12;
    let player2Beads = 12;
    let selectedCell = null;
    let validMoves = [];
    let captureMoves = [];
    let chainCapture = false;
    let chainCaptureFrom = null;
    let gameOver = false;

    // Online State
    let peer = null;
    let conn = null;
    let isHost = false;
    let myPlayerNumber = 0;
    let roomCode = '';
    let myName = '';
    let opponentName = '';
    let isOnline = false;
    let connectionTimeout = null;
    let isConnected = false;

    // Generate room code
    function generateRoomCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let code = '';
        for (let i = 0; i < ROOM_CODE_LENGTH; i++) {
            code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
    }

    // Initialize PeerJS
    function initializePeer(id = null) {
        return new Promise((resolve, reject) => {
            // Clean up existing peer
            if (peer) {
                peer.destroy();
                peer = null;
            }

            const peerId = id ? `baara-tehni-${id}` : undefined;
            
            // Use free PeerJS cloud server with explicit config
            peer = new Peer(peerId, {
                debug: 2,
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                }
            });

            const openTimeout = setTimeout(() => {
                reject(new Error('Peer initialization timeout'));
            }, 15000);

            peer.on('open', (id) => {
                clearTimeout(openTimeout);
                console.log('My Peer ID:', id);
                resolve(id);
            });

            peer.on('error', (err) => {
                clearTimeout(openTimeout);
                console.error('Peer error:', err);
                
                if (err.type === 'unavailable-id') {
                    showToast('Room code already in use. Try another.', 'error');
                } else if (err.type === 'peer-unavailable') {
                    showToast('Room not found. Check the code.', 'error');
                    const joinStatus = document.getElementById('joinStatus');
                    if (joinStatus) joinStatus.textContent = 'Room not found';
                    const joinBtn = document.getElementById('joinBtn');
                    if (joinBtn) joinBtn.disabled = false;
                } else if (err.type === 'network') {
                    showToast('Network error. Check your connection.', 'error');
                } else {
                    showToast('Connection error: ' + err.type, 'error');
                }
                reject(err);
            });

            // HOST: Listen for incoming connections
            peer.on('connection', (connection) => {
                console.log('Host received connection from guest');
                setupConnection(connection);
            });

            peer.on('disconnected', () => {
                console.log('Peer disconnected from server');
                // Try to reconnect
                if (peer && !peer.destroyed) {
                    peer.reconnect();
                }
            });
        });
    }

    // Setup connection handlers (used by both host and guest)
    function setupConnection(connection) {
        conn = connection;
        
        conn.on('open', () => {
            console.log('Connection opened successfully');
            isConnected = true;
            clearTimeout(connectionTimeout);
            
            if (isHost) {
                // Host sends their info first
                console.log('Host sending player info');
                document.getElementById('connectionStatus').textContent = 'Player connected! Sending game info...';
                
                setTimeout(() => {
                    sendData({
                        type: 'playerInfo',
                        name: myName,
                        playerNumber: 1
                    });
                }, 300);
            } else {
                // Guest waits for host info, then responds
                console.log('Guest connected, waiting for host info');
                document.getElementById('joinStatus').textContent = 'Connected! Waiting for host...';
            }
        });

        conn.on('data', (data) => {
            console.log('Received data:', data);
            handleMessage(data);
        });

        conn.on('close', () => {
            console.log('Connection closed');
            isConnected = false;
            if (isOnline && !gameOver) {
                showDisconnectModal();
            }
        });

        conn.on('error', (err) => {
            console.error('Connection error:', err);
            isConnected = false;
            showToast('Connection error: ' + err.message, 'error');
        });
    }

    // Safe send data function
    function sendData(data) {
        if (conn && conn.open) {
            console.log('Sending:', data);
            conn.send(data);
            return true;
        } else {
            console.error('Cannot send - connection not open');
            showToast('Connection lost. Cannot send data.', 'error');
            return false;
        }
    }

    // Handle incoming messages
    function handleMessage(data) {
        console.log('Processing message:', data.type);

        switch (data.type) {
            case 'playerInfo':
                handlePlayerInfo(data);
                break;

            case 'startGame':
                currentPlayer = data.firstPlayer;
                startOnlineGame();
                break;

            case 'move':
                receiveMove(data);
                break;

            case 'rematchRequest':
                showRematchRequest(data.from);
                break;

            case 'rematchAccepted':
                startRematch();
                break;

            case 'rematchDeclined':
                showToast('Rematch declined', 'info');
                break;

            case 'chat':
                showToast(`${opponentName}: ${data.message}`, 'info');
                break;
                
            case 'ping':
                sendData({ type: 'pong' });
                break;
                
            case 'pong':
                console.log('Connection alive');
                break;
        }
    }

    // Handle player info exchange
    function handlePlayerInfo(data) {
        opponentName = data.name;
        console.log('Received player info from:', opponentName);
        
        if (isHost) {
            // Host received guest's info
            player1Name = myName;
            player2Name = opponentName;
            console.log('Host: Game ready -', player1Name, 'vs', player2Name);
            showWaitingRoom();
        } else {
            // Guest received host's info
            myPlayerNumber = 2;
            player1Name = opponentName;
            player2Name = myName;
            console.log('Guest: Game ready -', player1Name, 'vs', player2Name);
            
            // Guest sends their info back
            setTimeout(() => {
                sendData({
                    type: 'playerInfo',
                    name: myName,
                    playerNumber: 2
                });
                showWaitingRoom();
            }, 200);
        }
    }

    // Show create room screen
    async function showCreateRoom() {
        myName = document.getElementById('playerNameInput').value.trim() || 'Player 1';
        roomCode = generateRoomCode();
        
        document.getElementById('mainMenuScreen').classList.add('hidden');
        document.getElementById('createRoomScreen').classList.remove('hidden');
        document.getElementById('roomCodeDisplay').textContent = roomCode;
        
        const roomLink = `${window.location.origin}${window.location.pathname}?room=${roomCode}`;
        document.getElementById('roomLinkDisplay').value = roomLink;
        document.getElementById('connectionStatus').textContent = 'Creating room...';

        try {
            await initializePeer(roomCode);
            isHost = true;
            myPlayerNumber = 1;
            player1Name = myName;
            document.getElementById('connectionStatus').textContent = '‚úì Room created! Share the code above.';
            showToast('Room created successfully!', 'success');
        } catch (err) {
            console.error('Failed to create room:', err);
            document.getElementById('connectionStatus').textContent = '‚úó Failed to create room. Try again.';
        }
    }

    // Show join room screen
    function showJoinRoom() {
        myName = document.getElementById('playerNameInput').value.trim() || 'Player 2';
        
        document.getElementById('mainMenuScreen').classList.add('hidden');
        document.getElementById('joinRoomScreen').classList.remove('hidden');
        document.getElementById('joinStatus').textContent = '';
        document.getElementById('joinBtn').disabled = false;

        // Check for room code in URL
        const urlParams = new URLSearchParams(window.location.search);
        const urlRoomCode = urlParams.get('room');
        if (urlRoomCode) {
            document.getElementById('joinCodeInput').value = urlRoomCode.toUpperCase();
        }
    }

    // Join room
    async function joinRoom() {
        const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
        if (code.length !== ROOM_CODE_LENGTH) {
            showToast('Please enter a valid 6-character code', 'error');
            return;
        }

        roomCode = code;
        document.getElementById('joinStatus').textContent = 'Initializing...';
        document.getElementById('joinBtn').disabled = true;

        try {
            // Initialize our peer first (without a specific ID)
            await initializePeer();
            isHost = false;
            
            document.getElementById('joinStatus').textContent = 'Connecting to room...';
            
            // Set connection timeout
            connectionTimeout = setTimeout(() => {
                if (!isConnected) {
                    document.getElementById('joinStatus').textContent = 'Connection timeout. Room may not exist or host disconnected.';
                    document.getElementById('joinBtn').disabled = false;
                    showToast('Connection timeout', 'error');
                    
                    if (conn) {
                        conn.close();
                        conn = null;
                    }
                }
            }, 15000);
            
            // Connect to host's peer
            console.log('Attempting to connect to:', `baara-tehni-${roomCode}`);
            const connection = peer.connect(`baara-tehni-${roomCode}`, {
                reliable: true,
                serialization: 'json'
            });
            
            if (!connection) {
                throw new Error('Failed to create connection');
            }
            
            setupConnection(connection);

        } catch (err) {
            console.error('Join room error:', err);
            document.getElementById('joinStatus').textContent = 'Failed to connect. Please try again.';
            document.getElementById('joinBtn').disabled = false;
            clearTimeout(connectionTimeout);
        }
    }

    // Show waiting room
    function showWaitingRoom() {
        document.getElementById('createRoomScreen').classList.add('hidden');
        document.getElementById('joinRoomScreen').classList.add('hidden');
        document.getElementById('waitingRoomScreen').classList.remove('hidden');

        document.getElementById('waitingPlayer1').textContent = player1Name;
        document.getElementById('waitingPlayer2').textContent = player2Name;

        if (isHost) {
            document.getElementById('hostControls').classList.remove('hidden');
            document.getElementById('guestWaiting').classList.add('hidden');
        } else {
            document.getElementById('hostControls').classList.add('hidden');
            document.getElementById('guestWaiting').classList.remove('hidden');
        }
        
        showToast('Both players connected!', 'success');
    }

    // Host starts game
    function hostStartGame() {
        if (!isConnected) {
            showToast('Connection lost. Cannot start game.', 'error');
            return;
        }
        
        // Random first player
        const firstPlayer = Math.random() < 0.5 ? 1 : 2;
        currentPlayer = firstPlayer;
        
        sendData({
            type: 'startGame',
            firstPlayer: firstPlayer
        });
        
        startOnlineGame();
    }

    // Start online game
    function startOnlineGame() {
        isOnline = true;
        gameOver = false;
        initializeBoard();
        
        document.getElementById('waitingRoomScreen').classList.add('hidden');
        document.getElementById('gameScreen').classList.remove('hidden');
        document.getElementById('onlineIndicator').classList.remove('hidden');
        
        document.getElementById('player1Name').textContent = player1Name;
        document.getElementById('player2Name').textContent = player2Name;

        // Show YOU badge
        if (myPlayerNumber === 1) {
            document.getElementById('player1You').classList.remove('hidden');
            document.getElementById('player2You').classList.add('hidden');
        } else {
            document.getElementById('player2You').classList.remove('hidden');
            document.getElementById('player1You').classList.add('hidden');
        }

        renderBoard();
        updateTurnUI();
        
        const firstPlayerName = currentPlayer === 1 ? player1Name : player2Name;
        showToast(`Game started! ${firstPlayerName} goes first.`, 'success');
    }

    // Initialize board
    function initializeBoard() {
        board = [];
        for (let i = 0; i < BOARD_SIZE; i++) {
            board[i] = [];
            for (let j = 0; j < BOARD_SIZE; j++) {
                if (i < 2) {
                    board[i][j] = 'X';
                } else if (i > 2) {
                    board[i][j] = 'O';
                } else if (i === 2) {
                    if (j < 2) board[i][j] = 'X';
                    else if (j > 2) board[i][j] = 'O';
                    else board[i][j] = '.';
                }
            }
        }
        player1Beads = 12;
        player2Beads = 12;
        selectedCell = null;
        validMoves = [];
        captureMoves = [];
        chainCapture = false;
    }

    // Check if it's my turn
    function isMyTurn() {
        if (!isOnline) return true;
        return currentPlayer === myPlayerNumber;
    }

    // Update turn UI
    function updateTurnUI() {
        const turnText = currentPlayer === 1 ? `${player1Name}'s Turn` : `${player2Name}'s Turn`;
        document.getElementById('turnText').textContent = turnText;

        // Show/hide waiting indicator
        if (isOnline) {
            if (isMyTurn()) {
                document.getElementById('waitingTurn').classList.add('hidden');
                document.getElementById('gameInstructions').classList.remove('hidden');
            } else {
                document.getElementById('waitingTurn').classList.remove('hidden');
                document.getElementById('gameInstructions').classList.add('hidden');
            }
        }

        // Highlight current player card
        const p1Card = document.getElementById('player1Card');
        const p2Card = document.getElementById('player2Card');
        
        if (currentPlayer === 1) {
            p1Card.classList.add('ring-2', 'ring-red-400', 'shadow-lg', 'shadow-red-500/20');
            p2Card.classList.remove('ring-2', 'ring-green-400', 'shadow-lg', 'shadow-green-500/20');
        } else {
            p2Card.classList.add('ring-2', 'ring-green-400', 'shadow-lg', 'shadow-green-500/20');
            p1Card.classList.remove('ring-2', 'ring-red-400', 'shadow-lg', 'shadow-red-500/20');
        }
    }

    // Render board
    function renderBoard() {
        const boardEl = document.getElementById('board');
        boardEl.innerHTML = '';
        
        const canInteract = !isOnline || isMyTurn();
        
        for (let i = 0; i < BOARD_SIZE; i++) {
            const row = document.createElement('div');
            row.className = 'flex items-center';
            
            const rowNum = document.createElement('div');
            rowNum.className = 'w-8 text-center text-cyan-400 font-medium';
            rowNum.textContent = i;
            row.appendChild(rowNum);

            for (let j = 0; j < BOARD_SIZE; j++) {
                const cell = document.createElement('div');
                cell.className = 'board-cell w-12 h-12 md:w-16 md:h-16 rounded-lg bg-slate-700/50 border border-slate-600/50 flex items-center justify-center cursor-pointer';
                cell.dataset.row = i;
                cell.dataset.col = j;

                if (!canInteract) {
                    cell.classList.add('disabled');
                }

                const isValidMove = validMoves.some(m => m.toR === i && m.toC === j);
                const isCaptureMove = captureMoves.some(m => m.toR === i && m.toC === j);
                
                if (isValidMove && canInteract) cell.classList.add('valid-move');
                if (isCaptureMove && canInteract) cell.classList.add('capture-move');

                if (board[i][j] === 'X') {
                    const piece = document.createElement('div');
                    piece.className = 'piece player1 w-9 h-9 md:w-12 md:h-12 rounded-full flex items-center justify-center text-white font-bold text-lg';
                    piece.textContent = 'X';
                    cell.appendChild(piece);
                    cell.classList.add('has-piece');
                } else if (board[i][j] === 'O') {
                    const piece = document.createElement('div');
                    piece.className = 'piece player2 w-9 h-9 md:w-12 md:h-12 rounded-full flex items-center justify-center text-white font-bold text-lg';
                    piece.textContent = 'O';
                    cell.appendChild(piece);
                    cell.classList.add('has-piece');
                }

                if (selectedCell && selectedCell.row === i && selectedCell.col === j) {
                    cell.classList.add('selected');
                }

                if (canInteract) {
                    cell.addEventListener('click', () => handleCellClick(i, j));
                }
                
                row.appendChild(cell);
            }
            boardEl.appendChild(row);
        }

        document.getElementById('player1Beads').textContent = player1Beads;
        document.getElementById('player2Beads').textContent = player2Beads;
        updateTurnUI();
    }

    // Handle cell click
    function handleCellClick(row, col) {
        if (!isMyTurn() && isOnline) return;
        
        const playerChar = currentPlayer === 1 ? 'X' : 'O';

        if (chainCapture) {
            const captureMove = captureMoves.find(m => m.toR === row && m.toC === col);
            if (captureMove) {
                executeCapture(captureMove, true);
                return;
            }
            return;
        }

        if (board[row][col] === playerChar) {
            selectedCell = { row, col };
            calculateValidMoves(row, col, playerChar);
            renderBoard();
            return;
        }

        if (selectedCell) {
            const simpleMove = validMoves.find(m => m.toR === row && m.toC === col && !m.isCapture);
            const captureMove = captureMoves.find(m => m.toR === row && m.toC === col);

            if (captureMove) {
                executeCapture(captureMove, true);
            } else if (simpleMove) {
                executeMove(simpleMove, true);
            } else {
                selectedCell = null;
                validMoves = [];
                captureMoves = [];
                renderBoard();
            }
        }
    }

    // Calculate valid moves
    function calculateValidMoves(fromR, fromC, playerChar) {
        validMoves = [];
        captureMoves = [];
        
        const directions = [
            [-1, 0], [1, 0], [0, -1], [0, 1],
            [-1, -1], [-1, 1], [1, -1], [1, 1]
        ];

        for (const [dr, dc] of directions) {
            const toR = fromR + dr;
            const toC = fromC + dc;
            if (isValidSimpleMove(fromR, fromC, toR, toC, playerChar)) {
                validMoves.push({ fromR, fromC, toR, toC, isCapture: false });
            }

            const capToR = fromR + dr * 2;
            const capToC = fromC + dc * 2;
            const captureInfo = isValidCapture(fromR, fromC, capToR, capToC, playerChar);
            if (captureInfo.valid) {
                captureMoves.push({ 
                    fromR, fromC, 
                    toR: capToR, toC: capToC, 
                    capR: captureInfo.capR, capC: captureInfo.capC,
                    isCapture: true 
                });
            }
        }
    }

    // Check valid simple move
    function isValidSimpleMove(fromR, fromC, toR, toC, playerChar) {
        if (toR < 0 || toR >= BOARD_SIZE || toC < 0 || toC >= BOARD_SIZE) return false;
        if (board[toR][toC] !== '.') return false;
        
        const dr = Math.abs(toR - fromR);
        const dc = Math.abs(toC - fromC);
        return dr <= 1 && dc <= 1 && !(dr === 0 && dc === 0);
    }

    // Check valid capture
    function isValidCapture(fromR, fromC, toR, toC, playerChar) {
        if (toR < 0 || toR >= BOARD_SIZE || toC < 0 || toC >= BOARD_SIZE) {
            return { valid: false };
        }
        if (board[toR][toC] !== '.') return { valid: false };
        
        const dr = toR - fromR;
        const dc = toC - fromC;
        if (!((dr === -2 || dr === 0 || dr === 2) && (dc === -2 || dc === 0 || dc === 2))) {
            return { valid: false };
        }
        if (dr === 0 && dc === 0) return { valid: false };
        
        const capR = fromR + dr / 2;
        const capC = fromC + dc / 2;
        const opponent = playerChar === 'X' ? 'O' : 'X';
        
        if (board[capR][capC] === opponent) {
            return { valid: true, capR, capC };
        }
        return { valid: false };
    }

    // Execute simple move
    function executeMove(move, sendToOpponent = false) {
        const playerChar = currentPlayer === 1 ? 'X' : 'O';
        board[move.toR][move.toC] = playerChar;
        board[move.fromR][move.fromC] = '.';
        
        showToast('Move successful! ‚úì', 'success');

        if (sendToOpponent && isOnline) {
            sendData({
                type: 'move',
                moveType: 'simple',
                move: move
            });
        }

        switchTurn();
    }

    // Execute capture
    function executeCapture(move, sendToOpponent = false) {
        const playerChar = currentPlayer === 1 ? 'X' : 'O';
        board[move.toR][move.toC] = playerChar;
        board[move.fromR][move.fromC] = '.';
        board[move.capR][move.capC] = '.';

        if (playerChar === 'X') {
            player2Beads--;
        } else {
            player1Beads--;
        }

        showToast('Captured! üéØ', 'capture');

        // Check for chain captures
        const chainMoves = [];
        const directions = [
            [-1, 0], [1, 0], [0, -1], [0, 1],
            [-1, -1], [-1, 1], [1, -1], [1, 1]
        ];

        for (const [dr, dc] of directions) {
            const capToR = move.toR + dr * 2;
            const capToC = move.toC + dc * 2;
            const captureInfo = isValidCapture(move.toR, move.toC, capToR, capToC, playerChar);
            if (captureInfo.valid) {
                chainMoves.push({
                    fromR: move.toR, fromC: move.toC,
                    toR: capToR, toC: capToC,
                    capR: captureInfo.capR, capC: captureInfo.capC,
                    isCapture: true
                });
            }
        }

        if (sendToOpponent && isOnline) {
            sendData({
                type: 'move',
                moveType: 'capture',
                move: move,
                hasChain: chainMoves.length > 0
            });
        }

        if (chainMoves.length > 0) {
            chainCapture = true;
            chainCaptureFrom = { row: move.toR, col: move.toC };
            selectedCell = chainCaptureFrom;
            validMoves = [];
            captureMoves = chainMoves;
            renderBoard();
            showToast('Chain capture available! üî•', 'info');
            return;
        }

        chainCapture = false;
        chainCaptureFrom = null;
        switchTurn();
    }

    // Receive move from opponent
    function receiveMove(data) {
        if (data.moveType === 'simple') {
            const move = data.move;
            const playerChar = currentPlayer === 1 ? 'X' : 'O';
            board[move.toR][move.toC] = playerChar;
            board[move.fromR][move.fromC] = '.';
            showToast('Opponent moved', 'info');
            switchTurn();
        } else if (data.moveType === 'capture') {
            const move = data.move;
            const playerChar = currentPlayer === 1 ? 'X' : 'O';
            board[move.toR][move.toC] = playerChar;
            board[move.fromR][move.fromC] = '.';
            board[move.capR][move.capC] = '.';

            if (playerChar === 'X') {
                player2Beads--;
            } else {
                player1Beads--;
            }

            showToast('Opponent captured!', 'capture');

            if (!data.hasChain) {
                switchTurn();
            } else {
                renderBoard();
            }
        }
    }

    // Switch turn
    function switchTurn() {
        selectedCell = null;
        validMoves = [];
        captureMoves = [];

        if (checkWinCondition()) return;

        currentPlayer = currentPlayer === 1 ? 2 : 1;
        renderBoard();

        if (!hasAnyMove(currentPlayer === 1 ? 'X' : 'O')) {
            const winner = currentPlayer === 1 ? player2Name : player1Name;
            showVictory(winner, 'No legal moves available!');
            return;
        }
    }

    // Check win condition
    function checkWinCondition() {
        if (player1Beads === 0) {
            showVictory(player2Name, 'All opponent beads captured!');
            return true;
        }
        if (player2Beads === 0) {
            showVictory(player1Name, 'All opponent beads captured!');
            return true;
        }
        return false;
    }

    // Check if player has any move
    function hasAnyMove(playerChar) {
        for (let i = 0; i < BOARD_SIZE; i++) {
            for (let j = 0; j < BOARD_SIZE; j++) {
                if (board[i][j] === playerChar) {
                    const directions = [
                        [-1, 0], [1, 0], [0, -1], [0, 1],
                        [-1, -1], [-1, 1], [1, -1], [1, 1]
                    ];
                    for (const [dr, dc] of directions) {
                        if (isValidSimpleMove(i, j, i + dr, j + dc, playerChar)) return true;
                        if (isValidCapture(i, j, i + dr * 2, j + dc * 2, playerChar).valid) return true;
                    }
                }
            }
        }
        return false;
    }

    // Show victory
    function showVictory(winner, reason) {
        gameOver = true;
        document.getElementById('winnerText').textContent = `${winner} Wins!`;
        document.getElementById('winReason').textContent = reason;
        document.getElementById('victoryModal').classList.remove('hidden');
        document.getElementById('rematchBtn').classList.remove('hidden');
    }

    // Request rematch
    function requestRematch() {
        if (isOnline && conn) {
            sendData({
                type: 'rematchRequest',
                from: myName
            });
            showToast('Rematch request sent!', 'info');
            document.getElementById('victoryModal').classList.add('hidden');
        }
    }

    // Show rematch request
    function showRematchRequest(from) {
        document.getElementById('rematchText').textContent = `${from} wants a rematch!`;
        document.getElementById('rematchModal').classList.remove('hidden');
    }

    // Accept rematch
    function acceptRematch() {
        document.getElementById('rematchModal').classList.add('hidden');
        if (isOnline && conn) {
            sendData({ type: 'rematchAccepted' });
        }
        startRematch();
    }

    // Decline rematch
    function declineRematch() {
        document.getElementById('rematchModal').classList.add('hidden');
        if (isOnline && conn) {
            sendData({ type: 'rematchDeclined' });
        }
    }

    // Start rematch
    function startRematch() {
        document.getElementById('victoryModal').classList.add('hidden');
        document.getElementById('rematchModal').classList.add('hidden');
        
        // Swap first player
        currentPlayer = currentPlayer === 1 ? 2 : 1;
        gameOver = false;
        initializeBoard();
        renderBoard();
        showToast('New game started!', 'success');
    }

    // Show disconnect modal
    function showDisconnectModal() {
        document.getElementById('disconnectModal').classList.remove('hidden');
    }

    // Leave game
    function leaveGame() {
        cleanupConnection();
        backToMenu();
    }
    
    // Cleanup connection
    function cleanupConnection() {
        clearTimeout(connectionTimeout);
        isConnected = false;
        
        if (conn) {
            conn.close();
            conn = null;
        }
        if (peer) {
            peer.destroy();
            peer = null;
        }
    }

    // Copy room code
    function copyRoomCode() {
        navigator.clipboard.writeText(roomCode);
        showToast('Room code copied! üìã', 'success');
    }

    // Copy room link
    function copyRoomLink() {
        const link = document.getElementById('roomLinkDisplay').value;
        navigator.clipboard.writeText(link);
        showToast('Room link copied! üìã', 'success');
    }

    // Back to menu
    function backToMenu() {
        cleanupConnection();
        
        isHost = false;
        isOnline = false;
        gameOver = false;
        isConnected = false;
        
        document.getElementById('createRoomScreen').classList.add('hidden');
        document.getElementById('joinRoomScreen').classList.add('hidden');
        document.getElementById('waitingRoomScreen').classList.add('hidden');
        document.getElementById('gameScreen').classList.add('hidden');
        document.getElementById('victoryModal').classList.add('hidden');
        document.getElementById('disconnectModal').classList.add('hidden');
        document.getElementById('rematchModal').classList.add('hidden');
        document.getElementById('mainMenuScreen').classList.remove('hidden');
        
        // Clear URL params
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    // Play offline (original game mode)
    function playOffline() {
        isOnline = false;
        player1Name = document.getElementById('playerNameInput').value.trim() || 'Player 1';
        player2Name = 'Player 2';
        myPlayerNumber = 1;
        currentPlayer = 1;
        
        initializeBoard();
        
        document.getElementById('mainMenuScreen').classList.add('hidden');
        document.getElementById('gameScreen').classList.remove('hidden');
        document.getElementById('onlineIndicator').classList.add('hidden');
        
        document.getElementById('player1Name').textContent = player1Name;
        document.getElementById('player2Name').textContent = player2Name;
        document.getElementById('player1You').classList.add('hidden');
        document.getElementById('player2You').classList.add('hidden');
        document.getElementById('waitingTurn').classList.add('hidden');
        document.getElementById('gameInstructions').classList.remove('hidden');
        
        renderBoard();
    }

    // Show toast
    function showToast(message, type) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        
        let bgColor = 'bg-slate-700';
        if (type === 'success') bgColor = 'bg-emerald-600';
        if (type === 'error') bgColor = 'bg-red-600';
        if (type === 'capture') bgColor = 'bg-purple-600';
        if (type === 'info') bgColor = 'bg-blue-600';
        
        toast.className = `toast px-4 py-2 rounded-lg ${bgColor} text-white font-medium shadow-lg`;
        toast.textContent = message;
        container.appendChild(toast);
        
        setTimeout(() => toast.remove(), 3000);
    }

    // Check for room code in URL on load
    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const urlRoomCode = urlParams.get('room');
        if (urlRoomCode) {
            showJoinRoom();
        }
    };
</script>
</body>
</html>
