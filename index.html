<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baara Tehni - Online Multiplayer</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Poppins', sans-serif; }
        
        .board-cell {
            transition: all 0.2s ease;
        }
        
        .board-cell:hover:not(.has-piece):not(.disabled) {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .board-cell.selected {
            box-shadow: 0 0 0 4px #fbbf24, 0 0 20px rgba(251, 191, 36, 0.5);
            transform: scale(1.1);
        }
        
        .board-cell.valid-move {
            background: rgba(34, 197, 94, 0.3);
            animation: pulse 1s infinite;
        }
        
        .board-cell.capture-move {
            background: rgba(239, 68, 68, 0.3);
            animation: pulse 1s infinite;
        }
        
        .board-cell.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .piece {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        
        .piece:hover {
            transform: scale(1.15);
        }
        
        .piece.player1 {
            background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.5), inset 0 2px 4px rgba(255,255,255,0.3);
        }
        
        .piece.player2 {
            background: linear-gradient(135deg, #22c55e 0%, #15803d 100%);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.5), inset 0 2px 4px rgba(255,255,255,0.3);
        }
        
        .game-board {
            background: linear-gradient(145deg, #1e3a5f 0%, #0f172a 100%);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), inset 0 0 60px rgba(255,255,255,0.05);
        }
        
        .floating {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .toast {
            animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s forwards;
        }
        
        @keyframes toastIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes toastOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        
        .btn-glow:hover {
            box-shadow: 0 0 20px currentColor;
        }
        
        .coin {
            animation: coinFlip 1s ease-in-out;
        }
        
        @keyframes coinFlip {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(1800deg); }
        }
        
        .connecting-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .pulse-ring {
            animation: pulseRing 2s infinite;
        }
        
        @keyframes pulseRing {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .copy-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

    <!-- Main Menu Screen -->
    <div id="mainMenuScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white/10 backdrop-blur-xl rounded-3xl p-8 max-w-md w-full border border-white/20 slide-in">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-500 mb-2">
                    üéÆ Baara Tehni
                </h1>
                <p class="text-white/60">Online Multiplayer</p>
                <p class="text-white/40 text-sm mt-2">The Classic 12 Beads Strategy Game</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-white/80 font-medium mb-2">Your Name</label>
                    <input type="text" id="playerNameInput" placeholder="Enter your name..." 
                        class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:border-amber-400 focus:ring-2 focus:ring-amber-400/20 transition">
                </div>
                
                <button onclick="showCreateRoom()" 
                    class="w-full py-4 rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold text-lg hover:from-amber-600 hover:to-orange-600 transition transform hover:scale-[1.02] active:scale-[0.98] shadow-lg shadow-orange-500/30">
                    üè† Create Room
                </button>
                
                <button onclick="showJoinRoom()" 
                    class="w-full py-4 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-semibold text-lg hover:from-emerald-600 hover:to-teal-600 transition transform hover:scale-[1.02] active:scale-[0.98] shadow-lg shadow-emerald-500/30">
                    üîó Join Room
                </button>
                
                <button onclick="playOffline()" 
                    class="w-full py-3 rounded-xl bg-white/10 border border-white/20 text-white font-medium hover:bg-white/20 transition">
                    üéØ Play Offline
                </button>
            </div>
            
            <div class="mt-8 text-center text-white/40 text-sm">
                <p>Create a room and share the code with friends to play together!</p>
            </div>
        </div>
    </div>

    <!-- Create Room Screen -->
    <div id="createRoomScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white/10 backdrop-blur-xl rounded-3xl p-8 max-w-md w-full border border-white/20 slide-in">
            <button onclick="backToMenu()" class="text-white/60 hover:text-white mb-4 flex items-center gap-2">
                ‚Üê Back
            </button>
            
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-white mb-2">üè† Create Room</h2>
                <p class="text-white/60">Share this code with your friend</p>
            </div>
            
            <div class="bg-white/5 rounded-2xl p-6 mb-6">
                <p class="text-white/60 text-sm mb-2 text-center">Room Code</p>
                <div class="flex items-center justify-center gap-3">
                    <span id="roomCodeDisplay" class="text-4xl font-bold text-amber-400 tracking-widest"></span>
                    <button onclick="copyRoomCode()" class="copy-btn p-2 rounded-lg bg-white/10 hover:bg-white/20 transition">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mt-4 pt-4 border-t border-white/10">
                    <p class="text-white/60 text-sm mb-2 text-center">Or share this link</p>
                    <div class="flex items-center gap-2">
                        <input type="text" id="roomLinkDisplay" readonly
                            class="flex-1 px-3 py-2 rounded-lg bg-white/10 text-white/80 text-sm truncate">
                        <button onclick="copyRoomLink()" class="copy-btn px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition text-white text-sm">
                            Copy
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="text-center">
                <div class="inline-flex items-center gap-3 px-4 py-2 rounded-full bg-white/5">
                    <div class="relative">
                        <div class="w-3 h-3 bg-amber-400 rounded-full"></div>
                        <div class="absolute inset-0 w-3 h-3 bg-amber-400 rounded-full pulse-ring"></div>
                    </div>
                    <span class="text-white/60">Waiting for opponent<span class="connecting-dots"></span></span>
                </div>
            </div>
            
            <div id="connectionStatus" class="mt-4 text-center text-white/40 text-sm"></div>
        </div>
    </div>

    <!-- Join Room Screen -->
    <div id="joinRoomScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white/10 backdrop-blur-xl rounded-3xl p-8 max-w-md w-full border border-white/20 slide-in">
            <button onclick="backToMenu()" class="text-white/60 hover:text-white mb-4 flex items-center gap-2">
                ‚Üê Back
            </button>
            
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-white mb-2">üîó Join Room</h2>
                <p class="text-white/60">Enter the room code to join</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-white/80 font-medium mb-2">Room Code</label>
                    <input type="text" id="joinCodeInput" placeholder="Enter 6-digit code..." maxlength="6"
                        class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-400/20 transition text-center text-2xl tracking-widest uppercase">
                </div>
                
                <button onclick="joinRoom()" id="joinBtn"
                    class="w-full py-4 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-semibold text-lg hover:from-emerald-600 hover:to-teal-600 transition transform hover:scale-[1.02] active:scale-[0.98] shadow-lg shadow-emerald-500/30">
                    Join Game üéÆ
                </button>
            </div>
            
            <div id="joinStatus" class="mt-4 text-center text-white/40 text-sm"></div>
        </div>
    </div>

    <!-- Waiting Room Screen -->
    <div id="waitingRoomScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white/10 backdrop-blur-xl rounded-3xl p-8 max-w-md w-full border border-white/20 slide-in text-center">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-white mb-2">üéÆ Game Ready!</h2>
                <p class="text-white/60">Both players connected</p>
            </div>
            
            <div class="flex items-center justify-center gap-6 mb-8">
                <div class="text-center">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center text-white font-bold text-2xl mb-2">X</div>
                    <p id="waitingPlayer1" class="text-white font-medium"></p>
                    <p class="text-red-400 text-sm">Player 1</p>
                </div>
                <div class="text-white/40 text-2xl">VS</div>
                <div class="text-center">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white font-bold text-2xl mb-2">O</div>
                    <p id="waitingPlayer2" class="text-white font-medium"></p>
                    <p class="text-green-400 text-sm">Player 2</p>
                </div>
            </div>
            
            <div id="hostControls" class="hidden">
                <button onclick="hostStartGame()" 
                    class="w-full py-4 rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold text-lg hover:from-amber-600 hover:to-orange-600 transition transform hover:scale-[1.02] active:scale-[0.98] shadow-lg shadow-orange-500/30">
                    Start Game ‚ú®
                </button>
            </div>
            
            <div id="guestWaiting" class="hidden">
                <div class="inline-flex items-center gap-3 px-4 py-2 rounded-full bg-white/5">
                    <div class="relative">
                        <div class="w-3 h-3 bg-emerald-400 rounded-full"></div>
                        <div class="absolute inset-0 w-3 h-3 bg-emerald-400 rounded-full pulse-ring"></div>
                    </div>
                    <span class="text-white/60">Waiting for host to start<span class="connecting-dots"></span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="hidden min-h-screen p-4 md:p-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-500">
                    Baara Tehni
                </h1>
                <div id="onlineIndicator" class="hidden inline-flex items-center gap-2 mt-2 px-3 py-1 rounded-full bg-emerald-500/20 border border-emerald-500/30">
                    <div class="w-2 h-2 bg-emerald-400 rounded-full"></div>
                    <span class="text-emerald-400 text-sm">Online</span>
                </div>
            </div>
            
            <!-- Player Info -->
            <div class="flex justify-between items-center mb-6 gap-4">
                <div id="player1Card" class="flex-1 p-4 rounded-2xl bg-gradient-to-r from-red-500/20 to-red-600/10 border border-red-500/30 transition-all">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center text-white font-bold shadow-lg">X</div>
                        <div>
                            <p id="player1Name" class="text-white font-semibold"></p>
                            <p class="text-white/60 text-sm"><span id="player1Beads">12</span> beads</p>
                        </div>
                        <span id="player1You" class="hidden ml-2 px-2 py-0.5 rounded text-xs bg-red-500/30 text-red-300">YOU</span>
                    </div>
                </div>
                
                <div id="turnIndicator" class="px-4 py-2 rounded-full bg-amber-500/20 border border-amber-500/30">
                    <span id="turnText" class="text-amber-400 font-medium text-sm"></span>
                </div>
                
                <div id="player2Card" class="flex-1 p-4 rounded-2xl bg-gradient-to-r from-green-600/10 to-green-500/20 border border-green-500/30 transition-all">
                    <div class="flex items-center gap-3 justify-end">
                        <span id="player2You" class="hidden mr-2 px-2 py-0.5 rounded text-xs bg-green-500/30 text-green-300">YOU</span>
                        <div class="text-right">
                            <p id="player2Name" class="text-white font-semibold"></p>
                            <p class="text-white/60 text-sm"><span id="player2Beads">12</span> beads</p>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white font-bold shadow-lg">O</div>
                    </div>
                </div>
            </div>
            
            <!-- Game Board -->
            <div class="flex justify-center mb-6">
                <div class="game-board rounded-2xl p-4 md:p-6">
                    <!-- Column Numbers -->
                    <div class="flex mb-2 pl-8">
                        <div class="w-12 md:w-16 text-center text-cyan-400 font-medium">0</div>
                        <div class="w-12 md:w-16 text-center text-cyan-400 font-medium">1</div>
                        <div class="w-12 md:w-16 text-center text-cyan-400 font-medium">2</div>
                        <div class="w-12 md:w-16 text-center text-cyan-400 font-medium">3</div>
                        <div class="w-12 md:w-16 text-center text-cyan-400 font-medium">4</div>
                    </div>
                    
                    <div id="board" class="grid gap-1"></div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex flex-wrap justify-center gap-3 mb-6">
                <button onclick="requestRematch()" id="rematchBtn" class="hidden px-5 py-2.5 rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-medium hover:from-amber-600 hover:to-orange-600 transition flex items-center gap-2">
                    üîÑ Rematch
                </button>
                <button onclick="leaveGame()" class="px-5 py-2.5 rounded-xl bg-white/10 border border-white/20 text-white font-medium hover:bg-white/20 transition flex items-center gap-2">
                    üö™ Leave Game
                </button>
            </div>
            
            <!-- Instructions -->
            <div id="gameInstructions" class="text-center text-white/40 text-sm">
                <p>Click a piece to select, then click an empty cell to move. Jump over enemies to capture!</p>
            </div>
            
            <div id="waitingTurn" class="hidden text-center">
                <div class="inline-flex items-center gap-3 px-4 py-2 rounded-full bg-white/5">
                    <div class="relative">
                        <div class="w-3 h-3 bg-blue-400 rounded-full"></div>
                        <div class="absolute inset-0 w-3 h-3 bg-blue-400 rounded-full pulse-ring"></div>
                    </div>
                    <span class="text-white/60">Waiting for opponent's move<span class="connecting-dots"></span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Victory Modal -->
    <div id="victoryModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-8 max-w-md w-full border border-white/20 text-center slide-in">
            <div class="text-6xl mb-4">üèÜ</div>
            <h2 id="winnerText" class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-500 mb-4"></h2>
            <p id="winReason" class="text-white/60 mb-8"></p>
            <div class="flex gap-3 justify-center">
                <button onclick="requestRematch()" id="modalRematchBtn"
                    class="px-8 py-3 rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold hover:from-amber-600 hover:to-orange-600 transition">
                    Rematch üîÑ
                </button>
                <button onclick="leaveGame()" 
                    class="px-8 py-3 rounded-xl bg-white/10 border border-white/20 text-white font-semibold hover:bg-white/20 transition">
                    Leave üö™
                </button>
            </div>
        </div>
    </div>

    <!-- Disconnection Modal -->
    <div id="disconnectModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-8 max-w-md w-full border border-white/20 text-center slide-in">
            <div class="text-6xl mb-4">üò¢</div>
            <h2 class="text-2xl font-bold text-white mb-4">Opponent Disconnected</h2>
            <p class="text-white/60 mb-8">Your opponent has left the game.</p>
            <button onclick="backToMenu()" 
                class="px-8 py-3 rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold hover:from-amber-600 hover:to-orange-600 transition">
                Back to Menu
            </button>
        </div>
    </div>

    <!-- Rematch Request Modal -->
    <div id="rematchModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-8 max-w-md w-full border border-white/20 text-center slide-in">
            <div class="text-6xl mb-4">üîÑ</div>
            <h2 class="text-2xl font-bold text-white mb-4">Rematch Request</h2>
            <p id="rematchText" class="text-white/60 mb-8"></p>
            <div class="flex gap-3 justify-center">
                <button onclick="acceptRematch()" 
                    class="px-8 py-3 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-semibold hover:from-emerald-600 hover:to-teal-600 transition">
                    Accept ‚úì
                </button>
                <button onclick="declineRematch()" 
                    class="px-8 py-3 rounded-xl bg-white/10 border border-white/20 text-white font-semibold hover:bg-white/20 transition">
                    Decline ‚úó
                </button>
            </div>
        </div>
    </div>

<script>
    // Game Constants
    const BOARD_SIZE = 5;
    const ROOM_CODE_LENGTH = 6;

    // Game State
    let board = [];
    let player1Name = '';
    let player2Name = '';
    let currentPlayer = 1;
    let player1Beads = 12;
    let player2Beads = 12;
    let selectedCell = null;
    let validMoves = [];
    let captureMoves = [];
    let chainCapture = false;
    let chainCaptureFrom = null;
    let gameOver = false;

    // Online State
    let peer = null;
    let conn = null;
    let isHost = false;
    let myPlayerNumber = 0;
    let roomCode = '';
    let myName = '';
    let opponentName = '';
    let isOnline = false;
    let connectionTimeout = null;
    let isConnected = false;
    let retryCount = 0;
    const MAX_RETRIES = 3;

    // Generate room code
    function generateRoomCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let code = '';
        for (let i = 0; i < ROOM_CODE_LENGTH; i++) {
            code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
    }

    // PeerJS Server configurations to try
    const PEER_SERVERS = [
        // Option 1: Default PeerJS cloud
        {
            name: 'PeerJS Cloud',
            config: {
                debug: 2,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        // Free TURN servers from Open Relay Project
                        {
                            urls: 'turn:openrelay.metered.ca:80',
                            username: 'openrelayproject',
                            credential: 'openrelayproject'
                        },
                        {
                            urls: 'turn:openrelay.metered.ca:443',
                            username: 'openrelayproject',
                            credential: 'openrelayproject'
                        },
                        {
                            urls: 'turn:openrelay.metered.ca:443?transport=tcp',
                            username: 'openrelayproject',
                            credential: 'openrelayproject'
                        }
                    ]
                }
            }
        },
        // Option 2: Alternative free PeerJS server
        {
            name: 'PeerJS EU',
            config: {
                host: '0.peerjs.com',
                port: 443,
                secure: true,
                debug: 2,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        {
                            urls: 'turn:openrelay.metered.ca:80',
                            username: 'openrelayproject',
                            credential: 'openrelayproject'
                        },
                        {
                            urls: 'turn:openrelay.metered.ca:443',
                            username: 'openrelayproject',
                            credential: 'openrelayproject'
                        }
                    ]
                }
            }
        }
    ];

    let currentServerIndex = 0;

    // Initialize PeerJS with fallback servers
    function initializePeer(id = null) {
        return new Promise((resolve, reject) => {
            // Clean up existing peer
            if (peer) {
                try {
                    peer.destroy();
                } catch (e) {
                    console.log('Peer cleanup:', e);
                }
                peer = null;
            }

            const peerId = id ? `game${id}` : `game${generateRoomCode()}${Date.now()}`;
            const serverConfig = PEER_SERVERS[currentServerIndex];
            
            console.log(`Trying server: ${serverConfig.name}`);
            console.log('Peer ID:', peerId);
            updateConnectionStatus(`Connecting to ${serverConfig.name}...`);

            try {
                peer = new Peer(peerId, serverConfig.config);
            } catch (e) {
                console.error('Failed to create peer:', e);
                tryNextServer(id, resolve, reject);
                return;
            }

            const openTimeout = setTimeout(() => {
                console.log('Timeout on', serverConfig.name);
                tryNextServer(id, resolve, reject);
            }, 10000);

            peer.on('open', (id) => {
                clearTimeout(openTimeout);
                console.log('‚úì Connected to', serverConfig.name);
                console.log('‚úì My Peer ID:', id);
                updateConnectionStatus(`Connected to ${serverConfig.name} ‚úì`);
                resolve(id);
            });

            peer.on('error', (err) => {
                clearTimeout(openTimeout);
                console.error(`Error on ${serverConfig.name}:`, err.type, err);
                
                if (err.type === 'unavailable-id') {
                    showToast('Room code in use. Try another.', 'error');
                    reject(err);
                } else if (err.type === 'peer-unavailable') {
                    showToast('Room not found. Check the code.', 'error');
                    const joinBtn = document.getElementById('joinBtn');
                    if (joinBtn) joinBtn.disabled = false;
                    reject(err);
                } else {
                    // Try next server
                    tryNextServer(id, resolve, reject);
                }
            });

            peer.on('connection', (connection) => {
                console.log('‚úì Incoming connection received!');
                updateConnectionStatus('Player connecting...');
                setupConnection(connection);
            });

            peer.on('disconnected', () => {
                console.log('Disconnected from server, reconnecting...');
                if (peer && !peer.destroyed) {
                    setTimeout(() => {
                        try { peer.reconnect(); } catch(e) {}
                    }, 1000);
                }
            });
        });
    }

    // Try next server in list
    function tryNextServer(id, resolve, reject) {
        currentServerIndex++;
        if (currentServerIndex < PEER_SERVERS.length) {
            console.log('Trying next server...');
            if (peer) {
                try { peer.destroy(); } catch(e) {}
                peer = null;
            }
            initializePeer(id).then(resolve).catch(reject);
        } else {
            currentServerIndex = 0;
            updateConnectionStatus('All servers failed. Check your internet.');
            showToast('Connection failed. Please check internet.', 'error');
            reject(new Error('All servers failed'));
        }
    }

    // Update status display
    function updateConnectionStatus(message) {
        console.log('Status:', message);
        const el1 = document.getElementById('connectionStatus');
        const el2 = document.getElementById('joinStatus');
        if (el1) el1.textContent = message;
        if (el2) el2.textContent = message;
    }

    // Setup connection handlers
    function setupConnection(connection) {
        conn = connection;
        console.log('Setting up connection...');
        console.log('Connection state:', connection.open ? 'open' : 'pending');
        
        conn.on('open', () => {
            console.log('‚úì‚úì‚úì DATA CONNECTION OPEN! ‚úì‚úì‚úì');
            isConnected = true;
            clearTimeout(connectionTimeout);
            retryCount = 0;
            
            if (isHost) {
                console.log('Host: Sending info to guest...');
                updateConnectionStatus('Guest connected! Sending game data...');
                
                setTimeout(() => {
                    sendData({
                        type: 'playerInfo',
                        name: myName,
                        playerNumber: 1
                    });
                }, 500);
            } else {
                console.log('Guest: Connected! Waiting for host info...');
                updateConnectionStatus('Connected! Waiting for host...');
            }
        });

        conn.on('data', (data) => {
            console.log('üì© Received:', data);
            handleMessage(data);
        });

        conn.on('close', () => {
            console.log('Connection closed');
            isConnected = false;
            if (isOnline && !gameOver) {
                showDisconnectModal();
            }
        });

        conn.on('error', (err) => {
            console.error('Connection error:', err);
            isConnected = false;
        });
    }

    // Send data safely
    function sendData(data) {
        if (conn && conn.open) {
            console.log('üì§ Sending:', data.type);
            try {
                conn.send(data);
                return true;
            } catch(e) {
                console.error('Send failed:', e);
                return false;
            }
        }
        console.error('Cannot send - no connection');
        return false;
    }

    // Handle messages
    function handleMessage(data) {
        console.log('Processing:', data.type);

        switch (data.type) {
            case 'playerInfo':
                opponentName = data.name;
                console.log('Got player info:', opponentName);
                
                if (isHost) {
                    player1Name = myName;
                    player2Name = opponentName;
                    showWaitingRoom();
                } else {
                    myPlayerNumber = 2;
                    player1Name = opponentName;
                    player2Name = myName;
                    
                    setTimeout(() => {
                        sendData({
                            type: 'playerInfo',
                            name: myName,
                            playerNumber: 2
                        });
                        showWaitingRoom();
                    }, 300);
                }
                break;

            case 'startGame':
                currentPlayer = data.firstPlayer;
                startOnlineGame();
                break;

            case 'move':
                receiveMove(data);
                break;

            case 'rematchRequest':
                showRematchRequest(data.from);
                break;

            case 'rematchAccepted':
                startRematch();
                break;

            case 'rematchDeclined':
                showToast('Rematch declined', 'info');
                break;
        }
    }

    // Create room
    async function showCreateRoom() {
        myName = document.getElementById('playerNameInput').value.trim() || 'Player 1';
        roomCode = generateRoomCode();
        currentServerIndex = 0;
        
        document.getElementById('mainMenuScreen').classList.add('hidden');
        document.getElementById('createRoomScreen').classList.remove('hidden');
        document.getElementById('roomCodeDisplay').textContent = roomCode;
        
        const roomLink = `${window.location.origin}${window.location.pathname}?room=${roomCode}`;
        document.getElementById('roomLinkDisplay').value = roomLink;
        updateConnectionStatus('Creating room...');

        try {
            await initializePeer(roomCode);
            isHost = true;
            myPlayerNumber = 1;
            player1Name = myName;
            updateConnectionStatus('‚úì Room ready! Share the code above.');
            showToast('Room created!', 'success');
        } catch (err) {
            updateConnectionStatus('Failed to create room. Try again.');
        }
    }

    // Show join screen
    function showJoinRoom() {
        myName = document.getElementById('playerNameInput').value.trim() || 'Player 2';
        currentServerIndex = 0;
        
        document.getElementById('mainMenuScreen').classList.add('hidden');
        document.getElementById('joinRoomScreen').classList.remove('hidden');
        document.getElementById('joinStatus').textContent = '';
        document.getElementById('joinBtn').disabled = false;

        const urlParams = new URLSearchParams(window.location.search);
        const urlRoomCode = urlParams.get('room');
        if (urlRoomCode) {
            document.getElementById('joinCodeInput').value = urlRoomCode.toUpperCase();
        }
    }

    // Join room
    async function joinRoom() {
        const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
        if (code.length !== ROOM_CODE_LENGTH) {
            showToast('Enter a valid 6-character code', 'error');
            return;
        }

        roomCode = code;
        document.getElementById('joinBtn').disabled = true;
        retryCount = 0;
        currentServerIndex = 0;
        
        await attemptJoin();
    }

    // Attempt join with retries
    async function attemptJoin() {
        retryCount++;
        updateConnectionStatus(`Joining... (Attempt ${retryCount}/${MAX_RETRIES})`);

        try {
            await initializePeer();
            isHost = false;
            
            updateConnectionStatus('Connecting to host...');
            
            connectionTimeout = setTimeout(() => {
                if (!isConnected) {
                    console.log('Timeout, attempt:', retryCount);
                    
                    if (retryCount < MAX_RETRIES) {
                        updateConnectionStatus(`Retrying... (${retryCount + 1}/${MAX_RETRIES})`);
                        cleanupConnection();
                        setTimeout(() => attemptJoin(), 1500);
                    } else {
                        updateConnectionStatus('Failed to connect. Make sure:\n‚Ä¢ Room code is correct\n‚Ä¢ Host has room open\n‚Ä¢ Both have internet');
                        document.getElementById('joinBtn').disabled = false;
                        showToast('Connection failed', 'error');
                    }
                }
            }, 15000);
            
            const hostPeerId = `game${roomCode}`;
            console.log('Connecting to:', hostPeerId);
            
            const connection = peer.connect(hostPeerId, {
                reliable: true,
                serialization: 'json'
            });
            
            if (!connection) {
                throw new Error('Failed to create connection');
            }
            
            setupConnection(connection);

        } catch (err) {
            console.error('Join error:', err);
            clearTimeout(connectionTimeout);
            
            if (retryCount < MAX_RETRIES) {
                setTimeout(() => attemptJoin(), 1500);
            } else {
                updateConnectionStatus('Failed: ' + err.message);
                document.getElementById('joinBtn').disabled = false;
            }
        }
    }

    // Show waiting room
    function showWaitingRoom() {
        document.getElementById('createRoomScreen').classList.add('hidden');
        document.getElementById('joinRoomScreen').classList.add('hidden');
        document.getElementById('waitingRoomScreen').classList.remove('hidden');

        document.getElementById('waitingPlayer1').textContent = player1Name;
        document.getElementById('waitingPlayer2').textContent = player2Name;

        if (isHost) {
            document.getElementById('hostControls').classList.remove('hidden');
            document.getElementById('guestWaiting').classList.add('hidden');
        } else {
            document.getElementById('hostControls').classList.add('hidden');
            document.getElementById('guestWaiting').classList.remove('hidden');
        }
        
        showToast('Both players connected! üéÆ', 'success');
    }

    // Host starts game
    function hostStartGame() {
        if (!isConnected) {
            showToast('Connection lost', 'error');
            return;
        }
        
        const firstPlayer = Math.random() < 0.5 ? 1 : 2;
        currentPlayer = firstPlayer;
        
        sendData({
            type: 'startGame',
            firstPlayer: firstPlayer
        });
        
        startOnlineGame();
    }

    // Start online game
    function startOnlineGame() {
        isOnline = true;
        gameOver = false;
        initializeBoard();
        
        document.getElementById('waitingRoomScreen').classList.add('hidden');
        document.getElementById('gameScreen').classList.remove('hidden');
        
        const onlineIndicator = document.getElementById('onlineIndicator');
        if (onlineIndicator) onlineIndicator.classList.remove('hidden');
        
        document.getElementById('player1Name').textContent = player1Name;
        document.getElementById('player2Name').textContent = player2Name;

        if (myPlayerNumber === 1) {
            document.getElementById('player1You').classList.remove('hidden');
            document.getElementById('player2You').classList.add('hidden');
        } else {
            document.getElementById('player2You').classList.remove('hidden');
            document.getElementById('player1You').classList.add('hidden');
        }

        renderBoard();
        updateTurnUI();
        
        const firstPlayerName = currentPlayer === 1 ? player1Name : player2Name;
        showToast(`${firstPlayerName} goes first!`, 'success');
    }

    // Initialize board
    function initializeBoard() {
        board = [];
        for (let i = 0; i < BOARD_SIZE; i++) {
            board[i] = [];
            for (let j = 0; j < BOARD_SIZE; j++) {
                if (i < 2) {
                    board[i][j] = 'X';
                } else if (i > 2) {
                    board[i][j] = 'O';
                } else if (i === 2) {
                    if (j < 2) board[i][j] = 'X';
                    else if (j > 2) board[i][j] = 'O';
                    else board[i][j] = '.';
                }
            }
        }
        player1Beads = 12;
        player2Beads = 12;
        selectedCell = null;
        validMoves = [];
        captureMoves = [];
        chainCapture = false;
    }

    function isMyTurn() {
        if (!isOnline) return true;
        return currentPlayer === myPlayerNumber;
    }

    function updateTurnUI() {
        const turnText = currentPlayer === 1 ? `${player1Name}'s Turn` : `${player2Name}'s Turn`;
        document.getElementById('turnText').textContent = turnText;

        if (isOnline) {
            const waitingTurn = document.getElementById('waitingTurn');
            const gameInstructions = document.getElementById('gameInstructions');
            
            if (waitingTurn && gameInstructions) {
                if (isMyTurn()) {
                    waitingTurn.classList.add('hidden');
                    gameInstructions.classList.remove('hidden');
                } else {
                    waitingTurn.classList.remove('hidden');
                    gameInstructions.classList.add('hidden');
                }
            }
        }

        const p1Card = document.getElementById('player1Card');
        const p2Card = document.getElementById('player2Card');
        
        if (p1Card && p2Card) {
            if (currentPlayer === 1) {
                p1Card.classList.add('ring-2', 'ring-red-400');
                p2Card.classList.remove('ring-2', 'ring-green-400');
            } else {
                p2Card.classList.add('ring-2', 'ring-green-400');
                p1Card.classList.remove('ring-2', 'ring-red-400');
            }
        }
    }

    function renderBoard() {
        const boardEl = document.getElementById('board');
        if (!boardEl) return;
        
        boardEl.innerHTML = '';
        const canInteract = !isOnline || isMyTurn();
        
        for (let i = 0; i < BOARD_SIZE; i++) {
            const row = document.createElement('div');
            row.className = 'flex items-center';
            
            const rowNum = document.createElement('div');
            rowNum.className = 'w-8 text-center text-cyan-400 font-medium';
            rowNum.textContent = i;
            row.appendChild(rowNum);

            for (let j = 0; j < BOARD_SIZE; j++) {
                const cell = document.createElement('div');
                cell.className = 'board-cell w-12 h-12 md:w-16 md:h-16 rounded-lg bg-slate-700/50 border border-slate-600/50 flex items-center justify-center cursor-pointer';

                if (!canInteract) cell.classList.add('disabled');

                const isValidMove = validMoves.some(m => m.toR === i && m.toC === j);
                const isCaptureMove = captureMoves.some(m => m.toR === i && m.toC === j);
                
                if (isValidMove && canInteract) cell.classList.add('valid-move');
                if (isCaptureMove && canInteract) cell.classList.add('capture-move');

                if (board[i][j] === 'X') {
                    const piece = document.createElement('div');
                    piece.className = 'piece player1 w-9 h-9 md:w-12 md:h-12 rounded-full flex items-center justify-center text-white font-bold text-lg';
                    piece.textContent = 'X';
                    cell.appendChild(piece);
                } else if (board[i][j] === 'O') {
                    const piece = document.createElement('div');
                    piece.className = 'piece player2 w-9 h-9 md:w-12 md:h-12 rounded-full flex items-center justify-center text-white font-bold text-lg';
                    piece.textContent = 'O';
                    cell.appendChild(piece);
                }

                if (selectedCell && selectedCell.row === i && selectedCell.col === j) {
                    cell.classList.add('selected');
                }

                if (canInteract) {
                    cell.addEventListener('click', () => handleCellClick(i, j));
                }
                
                row.appendChild(cell);
            }
            boardEl.appendChild(row);
        }

        document.getElementById('player1Beads').textContent = player1Beads;
        document.getElementById('player2Beads').textContent = player2Beads;
        updateTurnUI();
    }

    function handleCellClick(row, col) {
        if (!isMyTurn() && isOnline) return;
        
        const playerChar = currentPlayer === 1 ? 'X' : 'O';

        if (chainCapture) {
            const captureMove = captureMoves.find(m => m.toR === row && m.toC === col);
            if (captureMove) {
                executeCapture(captureMove, true);
            }
            return;
        }

        if (board[row][col] === playerChar) {
            selectedCell = { row, col };
            calculateValidMoves(row, col, playerChar);
            renderBoard();
            return;
        }

        if (selectedCell) {
            const simpleMove = validMoves.find(m => m.toR === row && m.toC === col && !m.isCapture);
            const captureMove = captureMoves.find(m => m.toR === row && m.toC === col);

            if (captureMove) {
                executeCapture(captureMove, true);
            } else if (simpleMove) {
                executeMove(simpleMove, true);
            } else {
                selectedCell = null;
                validMoves = [];
                captureMoves = [];
                renderBoard();
            }
        }
    }

    function calculateValidMoves(fromR, fromC, playerChar) {
        validMoves = [];
        captureMoves = [];
        
        const directions = [[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]];

        for (const [dr, dc] of directions) {
            const toR = fromR + dr;
            const toC = fromC + dc;
            if (isValidSimpleMove(fromR, fromC, toR, toC, playerChar)) {
                validMoves.push({ fromR, fromC, toR, toC, isCapture: false });
            }

            const capToR = fromR + dr * 2;
            const capToC = fromC + dc * 2;
            const captureInfo = isValidCapture(fromR, fromC, capToR, capToC, playerChar);
            if (captureInfo.valid) {
                captureMoves.push({ 
                    fromR, fromC, 
                    toR: capToR, toC: capToC, 
                    capR: captureInfo.capR, capC: captureInfo.capC,
                    isCapture: true 
                });
            }
        }
    }

    function isValidSimpleMove(fromR, fromC, toR, toC, playerChar) {
        if (toR < 0 || toR >= BOARD_SIZE || toC < 0 || toC >= BOARD_SIZE) return false;
        if (board[toR][toC] !== '.') return false;
        const dr = Math.abs(toR - fromR);
        const dc = Math.abs(toC - fromC);
        return dr <= 1 && dc <= 1 && !(dr === 0 && dc === 0);
    }

    function isValidCapture(fromR, fromC, toR, toC, playerChar) {
        if (toR < 0 || toR >= BOARD_SIZE || toC < 0 || toC >= BOARD_SIZE) return { valid: false };
        if (board[toR][toC] !== '.') return { valid: false };
        
        const dr = toR - fromR;
        const dc = toC - fromC;
        if (!((dr === -2 || dr === 0 || dr === 2) && (dc === -2 || dc === 0 || dc === 2))) return { valid: false };
        if (dr === 0 && dc === 0) return { valid: false };
        
        const capR = fromR + dr / 2;
        const capC = fromC + dc / 2;
        const opponent = playerChar === 'X' ? 'O' : 'X';
        
        if (board[capR][capC] === opponent) return { valid: true, capR, capC };
        return { valid: false };
    }

    function executeMove(move, sendToOpponent = false) {
        const playerChar = currentPlayer === 1 ? 'X' : 'O';
        board[move.toR][move.toC] = playerChar;
        board[move.fromR][move.fromC] = '.';
        
        showToast('Move! ‚úì', 'success');

        if (sendToOpponent && isOnline) {
            sendData({ type: 'move', moveType: 'simple', move: move });
        }

        switchTurn();
    }

    function executeCapture(move, sendToOpponent = false) {
        const playerChar = currentPlayer === 1 ? 'X' : 'O';
        board[move.toR][move.toC] = playerChar;
        board[move.fromR][move.fromC] = '.';
        board[move.capR][move.capC] = '.';

        if (playerChar === 'X') player2Beads--;
        else player1Beads--;

        showToast('Captured! üéØ', 'capture');

        const chainMoves = [];
        const directions = [[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]];

        for (const [dr, dc] of directions) {
            const capToR = move.toR + dr * 2;
            const capToC = move.toC + dc * 2;
            const captureInfo = isValidCapture(move.toR, move.toC, capToR, capToC, playerChar);
            if (captureInfo.valid) {
                chainMoves.push({
                    fromR: move.toR, fromC: move.toC,
                    toR: capToR, toC: capToC,
                    capR: captureInfo.capR, capC: captureInfo.capC,
                    isCapture: true
                });
            }
        }

        if (sendToOpponent && isOnline) {
            sendData({ type: 'move', moveType: 'capture', move: move, hasChain: chainMoves.length > 0 });
        }

        if (chainMoves.length > 0) {
            chainCapture = true;
            chainCaptureFrom = { row: move.toR, col: move.toC };
            selectedCell = chainCaptureFrom;
            validMoves = [];
            captureMoves = chainMoves;
            renderBoard();
            showToast('Chain capture! üî•', 'info');
            return;
        }

        chainCapture = false;
        chainCaptureFrom = null;
        switchTurn();
    }

    function receiveMove(data) {
        const move = data.move;
        const playerChar = currentPlayer === 1 ? 'X' : 'O';
        
        board[move.toR][move.toC] = playerChar;
        board[move.fromR][move.fromC] = '.';
        
        if (data.moveType === 'capture') {
            board[move.capR][move.capC] = '.';
            if (playerChar === 'X') player2Beads--;
            else player1Beads--;
            showToast('Opponent captured!', 'capture');
            
            if (data.hasChain) {
                renderBoard();
                return;
            }
        } else {
            showToast('Opponent moved', 'info');
        }
        
        switchTurn();
    }

    function switchTurn() {
        selectedCell = null;
        validMoves = [];
        captureMoves = [];

        if (checkWinCondition()) return;

        currentPlayer = currentPlayer === 1 ? 2 : 1;
        renderBoard();

        if (!hasAnyMove(currentPlayer === 1 ? 'X' : 'O')) {
            const winner = currentPlayer === 1 ? player2Name : player1Name;
            showVictory(winner, 'No moves available!');
        }
    }

    function checkWinCondition() {
        if (player1Beads === 0) {
            showVictory(player2Name, 'All beads captured!');
            return true;
        }
        if (player2Beads === 0) {
            showVictory(player1Name, 'All beads captured!');
            return true;
        }
        return false;
    }

    function hasAnyMove(playerChar) {
        for (let i = 0; i < BOARD_SIZE; i++) {
            for (let j = 0; j < BOARD_SIZE; j++) {
                if (board[i][j] === playerChar) {
                    const directions = [[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]];
                    for (const [dr, dc] of directions) {
                        if (isValidSimpleMove(i, j, i + dr, j + dc, playerChar)) return true;
                        if (isValidCapture(i, j, i + dr * 2, j + dc * 2, playerChar).valid) return true;
                    }
                }
            }
        }
        return false;
    }

    function showVictory(winner, reason) {
        gameOver = true;
        document.getElementById('winnerText').textContent = `${winner} Wins!`;
        document.getElementById('winReason').textContent = reason;
        document.getElementById('victoryModal').classList.remove('hidden');
    }

    function requestRematch() {
        if (isOnline && conn && conn.open) {
            sendData({ type: 'rematchRequest', from: myName });
            showToast('Rematch sent!', 'info');
            document.getElementById('victoryModal').classList.add('hidden');
        }
    }

    function showRematchRequest(from) {
        document.getElementById('rematchText').textContent = `${from} wants a rematch!`;
        document.getElementById('rematchModal').classList.remove('hidden');
    }

    function acceptRematch() {
        document.getElementById('rematchModal').classList.add('hidden');
        sendData({ type: 'rematchAccepted' });
        startRematch();
    }

    function declineRematch() {
        document.getElementById('rematchModal').classList.add('hidden');
        sendData({ type: 'rematchDeclined' });
    }

    function startRematch() {
        document.getElementById('victoryModal').classList.add('hidden');
        document.getElementById('rematchModal').classList.add('hidden');
        currentPlayer = currentPlayer === 1 ? 2 : 1;
        gameOver = false;
        initializeBoard();
        renderBoard();
        showToast('New game!', 'success');
    }

    function showDisconnectModal() {
        const modal = document.getElementById('disconnectModal');
        if (modal) modal.classList.remove('hidden');
    }

    function cleanupConnection() {
        clearTimeout(connectionTimeout);
        isConnected = false;
        retryCount = 0;
        if (conn) { try { conn.close(); } catch(e) {} conn = null; }
        if (peer) { try { peer.destroy(); } catch(e) {} peer = null; }
    }

    function leaveGame() {
        cleanupConnection();
        backToMenu();
    }

    function copyRoomCode() {
        navigator.clipboard.writeText(roomCode);
        showToast('Code copied! üìã', 'success');
    }

    function copyRoomLink() {
        const link = document.getElementById('roomLinkDisplay').value;
        navigator.clipboard.writeText(link);
        showToast('Link copied! üìã', 'success');
    }

    function backToMenu() {
        cleanupConnection();
        isHost = false;
        isOnline = false;
        gameOver = false;
        isConnected = false;
        currentServerIndex = 0;
        
        ['createRoomScreen','joinRoomScreen','waitingRoomScreen','gameScreen','victoryModal','disconnectModal','rematchModal'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.add('hidden');
        });
        
        document.getElementById('mainMenuScreen').classList.remove('hidden');
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    function playOffline() {
        isOnline = false;
        player1Name = document.getElementById('playerNameInput').value.trim() || 'Player 1';
        player2Name = 'Player 2';
        myPlayerNumber = 1;
        currentPlayer = 1;
        
        initializeBoard();
        
        document.getElementById('mainMenuScreen').classList.add('hidden');
        document.getElementById('gameScreen').classList.remove('hidden');
        
        const onlineIndicator = document.getElementById('onlineIndicator');
        if (onlineIndicator) onlineIndicator.classList.add('hidden');
        
        document.getElementById('player1Name').textContent = player1Name;
        document.getElementById('player2Name').textContent = player2Name;
        
        ['player1You','player2You','waitingTurn'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.add('hidden');
        });
        
        const gi = document.getElementById('gameInstructions');
        if (gi) gi.classList.remove('hidden');
        
        renderBoard();
    }

    function showToast(message, type) {
        const container = document.getElementById('toastContainer');
        if (!container) { console.log('Toast:', message); return; }
        
        const toast = document.createElement('div');
        let bg = 'bg-slate-700';
        if (type === 'success') bg = 'bg-emerald-600';
        if (type === 'error') bg = 'bg-red-600';
        if (type === 'capture') bg = 'bg-purple-600';
        if (type === 'info') bg = 'bg-blue-600';
        
        toast.className = `px-4 py-2 rounded-lg ${bg} text-white font-medium shadow-lg mb-2`;
        toast.textContent = message;
        container.appendChild(toast);
        
        setTimeout(() => { if (toast.parentNode) toast.remove(); }, 3000);
    }

    // Debug function - call from console
    window.debugConnection = function() {
        console.log('=== DEBUG INFO ===');
        console.log('Peer:', peer ? (peer.destroyed ? 'destroyed' : 'active') : 'null');
        console.log('Peer ID:', peer ? peer.id : 'N/A');
        console.log('Connection:', conn ? (conn.open ? 'open' : 'closed') : 'null');
        console.log('isHost:', isHost);
        console.log('isConnected:', isConnected);
        console.log('Room Code:', roomCode);
        console.log('Server Index:', currentServerIndex);
        console.log('==================');
    };

    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const urlRoomCode = urlParams.get('room');
        if (urlRoomCode) showJoinRoom();
        console.log('Game loaded. Type debugConnection() for debug info.');
    };
</script>
</body>
</html>
